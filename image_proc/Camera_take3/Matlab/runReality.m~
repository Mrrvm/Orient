close all;
clear;

samplePer = 0.10;          % ransac parameters
enoughPer = 0.50;         % ...
maxIters = 20;               % ...
maxErr =  0.0003;          % ...
B         = [0.0 0.0 0.01]';  % baseline
radius = 1;
K = [1.1446e+03 0                    9.8904e+02; 
        0                  1.1452e+03  7.554e+02  ;
        0                  0                    1                 ];
    
%% Obtain 2D points from camera images
[imgs1, imgs2, axisCount] = readImages('../cam_img');

i = 1;
j
for k = 1:numel(imgs1)
    %% Extract matches from images
    img1 = imgs1(k).data;
    img2 = imgs2(k).data;
    p1 = detectSURFFeatures(img1);
    p2 = detectSURFFeatures(img2);
    [f1,vpts1] = extractFeatures(img1, p1);
    [f2,vpts2] = extractFeatures(img2, p2);
    matches = matchFeatures(f1, f2, 'Method', 'Exhaustive',  'MatchThreshold', 100, 'Unique', true);
    m1a = vpts1(matches(:,1));
    m2a = vpts2(matches(:,2));
    bestInds = ransacByProcrustes(m1a.Location', m2a.Location', K, radius, maxErr, maxIters, samplePer, enoughPer);
    m1Best = m1a(bestInds'>0,:);
    m2Best = m2a(bestInds'>0,:);
    figure; showMatchedFeatures(img1, img2, m1Best', m2Best');
    
    m1 = double(m1Best.Location');
    m2 = double(m2Best.Location');
    
    if k == axisCount(1) + 1
        i = 2; % change to y
        j = 1;
    end
    if k == axisCount(2) + 1
            i = 3; % change to z
            j = 1;
    end
    
    if i == 1
        angles = [imgs1(k).angle 0 0];
    else
        if i == 2
            angles = [0 imgs1(k).angle 0];
        else 
            if i ==3
                angles = [0 0 imgs1(k).angle];
            end
        end
    end
    
    R = getRmatrix(angles);
    %% Estimate transformation error
    [eRoppr(i,j), eRfpro(i,j), eRmbpe(i,j), eRepog(i,j) ]= estimator(m1, m2, radius, K, B, R);
    j = j + 1;

end



